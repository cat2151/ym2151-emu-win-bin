# ライブラリ構造の可視化

このドキュメントは、当リポジトリが提供するライブラリの構造を図解します。

## 修正前の誤解を招く構造

```
┌─────────────────────────────────────────────────┐
│ ym2151-emu-win-bin リポジトリ                   │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │ Rust: ym2151.dll / libym2151.a       │ ← 名前が不明瞭
│  │ ┌──────────────────────────────┐     │      │
│  │ │ lib.rs (wrapper?)            │ ← 誤ったシグネチャ
│  │ └──────────────────────────────┘     │      │
│  │ ┌──────────────────────────────┐     │      │
│  │ │ build.rs                     │     │      │
│  │ │ → opm.c をコンパイル         │     │      │
│  │ └──────────────────────────────┘     │      │
│  └──────────────────────────────────────┘      │
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │ Go: libym2151.a                      │ ← 名前が不明瞭
│  │ ┌──────────────────────────────┐     │      │
│  │ │ ym2151.h                     │     │      │
│  │ │ → opm.h をインクルード       │ ✓ 正しい
│  │ └──────────────────────────────┘     │      │
│  │ ┌──────────────────────────────┐     │      │
│  │ │ Makefile                     │     │      │
│  │ │ → opm.c をコンパイル         │     │      │
│  │ └──────────────────────────────┘     │      │
│  └──────────────────────────────────────┘      │
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │ Python: ym2151.dll                   │ ← 名前が不明瞭
│  │ ┌──────────────────────────────┐     │      │
│  │ │ Makefile                     │     │      │
│  │ │ → opm.c をコンパイル         │ ✓ 正しい
│  │ └──────────────────────────────┘     │      │
│  └──────────────────────────────────────┘      │
│                                                 │
└─────────────────────────────────────────────────┘
        ↓
        使用するユーザー
        
問題点:
❌ ライブラリ名からNuked-OPMであることが分からない
❌ カスタムwrapperと誤解される
❌ Rust lib.rsの宣言が公式APIと異なる
```

---

## 修正後の明確な構造

```
┌─────────────────────────────────────────────────┐
│ ym2151-emu-win-bin リポジトリ                   │
│ （公式Nuked-OPMビルド提供）                     │
├─────────────────────────────────────────────────┤
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │ Rust: nukedopm.dll / libnukedopm.a   │ ✓ 明確
│  │ ┌──────────────────────────────┐     │      │
│  │ │ lib.rs (ドキュメントのみ)    │ ✓ 修正済み
│  │ │ → 公式API使用を明記          │      │
│  │ └──────────────────────────────┘     │      │
│  │ ┌──────────────────────────────┐     │      │
│  │ │ build.rs                     │     │      │
│  │ │ → opm.c をコンパイル         │     │      │
│  │ └──────────────────────────────┘     │      │
│  │                                      │      │
│  │ エクスポート: OPM_Reset,            │      │
│  │              OPM_Write,             │      │
│  │              OPM_Clock, ...         │      │
│  └──────────────────────────────────────┘      │
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │ Go: libnukedopm.a                    │ ✓ 明確
│  │ ┌──────────────────────────────┐     │      │
│  │ │ ym2151.h                     │     │      │
│  │ │ → opm.h をインクルード       │     │      │
│  │ └──────────────────────────────┘     │      │
│  │ ┌──────────────────────────────┐     │      │
│  │ │ Makefile                     │     │      │
│  │ │ → opm.c をコンパイル         │     │      │
│  │ └──────────────────────────────┘     │      │
│  │                                      │      │
│  │ エクスポート: OPM_Reset,            │      │
│  │              OPM_Write,             │      │
│  │              OPM_Clock, ...         │      │
│  └──────────────────────────────────────┘      │
│                                                 │
│  ┌──────────────────────────────────────┐      │
│  │ Python: nukedopm.dll                 │ ✓ 明確
│  │ ┌──────────────────────────────┐     │      │
│  │ │ Makefile                     │     │      │
│  │ │ → opm.c をコンパイル         │     │      │
│  │ └──────────────────────────────┘     │      │
│  │                                      │      │
│  │ エクスポート: OPM_Reset,            │      │
│  │              OPM_Write,             │      │
│  │              OPM_Clock, ...         │      │
│  └──────────────────────────────────────┘      │
│                                                 │
└─────────────────────────────────────────────────┘
        ↓
        使用するユーザー
        ↓
    公式opm.hを参照可能
        ↓
    https://github.com/nukeykt/Nuked-OPM
    
改善点:
✅ ライブラリ名からNuked-OPMであることが分かる
✅ 公式APIをそのまま提供していることが明確
✅ ユーザーは公式ドキュメントを参照できる
```

---

## ビルドフロー

### すべての言語で共通のフロー

```
┌─────────────────────┐
│ 公式Nuked-OPM       │
│ github.com/         │
│  nukeykt/Nuked-OPM  │
└──────────┬──────────┘
           │ git clone
           ↓
┌─────────────────────┐
│ vendor/nuked-opm/   │
│  ├── opm.h          │ ← 公式ヘッダ
│  └── opm.c          │ ← 公式実装
└──────────┬──────────┘
           │
           │ コンパイル
           ↓
┌─────────────────────┐
│ ビルド済みライブラリ│
│                     │
│ Rust: libnukedopm.a │ ← 公式API
│       nukedopm.dll  │ ← 公式API
│                     │
│ Go: libnukedopm.a   │ ← 公式API
│                     │
│ Python: nukedopm.dll│ ← 公式API
│      ym2151.dll (※) │ ← 公式API
└──────────┬──────────┘
           │
           ↓
    ユーザーのプロジェクト
           │
           ↓
    公式APIで使用:
    - OPM_Reset()
    - OPM_Write()
    - OPM_Clock()
    - etc.
```

---

## APIの流れ

### 公式Nuked-OPM API

```c
// opm.h (公式)
typedef struct { /* ... */ } opm_t;

void OPM_Reset(opm_t *chip);
void OPM_Write(opm_t *chip, uint32_t port, uint8_t data);
void OPM_Clock(opm_t *chip, 
               int32_t *output,  // ステレオ出力（2要素配列）
               uint8_t *sh1,     // サンプルホールド1
               uint8_t *sh2,     // サンプルホールド2
               uint8_t *so);     // シリアル出力
```

### 各言語での使用

#### Rust
```rust
extern "C" {
    fn OPM_Reset(chip: *mut opm_t);
    fn OPM_Write(chip: *mut opm_t, port: u32, data: u8);
    fn OPM_Clock(chip: *mut opm_t, 
                 output: *mut i32,
                 sh1: *mut u8,
                 sh2: *mut u8,
                 so: *mut u8);
}
```

#### Go
```go
/*
#include "vendor/nuked-opm/opm.h"
*/
import "C"

var chip C.opm_t
C.OPM_Reset(&chip)
C.OPM_Write(&chip, 0, 0x20)
```

#### Python
```python
lib = ctypes.CDLL('./nukedopm.dll')

lib.OPM_Reset.argtypes = [ctypes.POINTER(opm_t)]
lib.OPM_Write.argtypes = [ctypes.POINTER(opm_t), 
                          ctypes.c_uint32, 
                          ctypes.c_uint8]
```

**すべて公式APIと同じシグネチャ！** ✅

---

## まとめ

### 修正のポイント

1. **ライブラリ名**: `ym2151.*` → `nukedopm.*`
   - Nuked-OPMであることが明確
   
2. **API**: 変更なし
   - すでに公式APIを提供していた
   - Rustのlib.rsの誤った宣言を削除
   
3. **ドキュメント**: 充実
   - 公式APIを提供していることを明記
   - ユーザーは公式opm.hを参照可能

### 利点

- ✅ 出所が明確（Nuked-OPM）
- ✅ カスタムラッパーではないことが明確
- ✅ ユーザーは公式ドキュメントを参照可能
- ✅ 混乱が減る
